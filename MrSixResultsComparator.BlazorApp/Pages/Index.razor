@page "/"
@using MrSixResultsComparator.Core.Configuration
@using MrSixResultsComparator.Core.Services
@using MrSixResultsComparator.Core.Models
@using MrSixResultsComparator.BlazorApp.Data
@inject AppConfiguration Config
@inject MrSixContextService ContextService
@inject ShardValidationService ShardValidationService
@inject SearchParameterService SearchParameterService
@inject StackSearchService StackSearchService
@inject OnePushService OnePushService
@inject LitBatchService LitBatchService
@inject LitSearchService LitSearchService
@inject MoreLikeThisService MoreLikeThisService
@inject OneWayService OneWayService
@inject ExpertPicksService ExpertPicksService
@inject JustForYouService JustForYouService
@inject MatchPicksService MatchPicksService
@inject ReverseService ReverseService
@inject SearchWowService SearchWowService
@inject TwoWayService TwoWayService
@inject ComparisonStateService StateService
@implements IDisposable

<div class="header">
    <div class="container">
        <h1>üîç MrSix Results Comparator</h1>
        <p>Compare search results between Control and Test environments</p>
    </div>
</div>


<div class="container">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="card">
            <h2>Configuration</h2>
            <div class="config-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Control Server</label>
                    <input type="text" @bind="Config.MrSixControl" disabled="@(StateService.IsRunning || isInitializing)" />
                </div>
                <div class="form-group">
                    <label>Test Server</label>
                    <input type="text" @bind="Config.MrSixTest" disabled="@(StateService.IsRunning || isInitializing)" />
                </div>
                <div class="form-group">
                    <label>Max Parallelism</label>
                    <input type="number" @bind="Config.MaxParallelism" min="1" max="20" disabled="@(StateService.IsRunning || isInitializing)" />
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <label style="margin: 0;">
                        <input type="checkbox" @bind="Config.IgnoreRecentLogins" disabled="@(StateService.IsRunning || isInitializing)" />
                        Ignore recent logins (data movement)
                    </label>
                    <input type="number" @bind="Config.RecentLoginThresholdMinutes" min="1" max="1440" 
                           style="width: 70px;" disabled="@(StateService.IsRunning || isInitializing || !Config.IgnoreRecentLogins)" 
                           title="Threshold in minutes" />
                    <span style="font-size: 0.85rem; color: #666;">min</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-primary" @onclick="StartComparison" disabled="@(StateService.IsRunning || isInitializing || isRefreshingParameters)">
                    @if (isInitializing)
                    {
                        <span>‚è≥ Loading...</span>
                    }
                    else if (StateService.IsRunning)
                    {
                        <span>‚è≥ Running...</span>
                    }
                    else
                    {
                        <span>‚ñ∂Ô∏è Start Comparison</span>
                    }
                </button>
                @if (StateService.IsRunning || isInitializing)
                {
                    <button class="btn btn-danger" @onclick="CancelComparison">
                        ‚õî Cancel
                    </button>
                }
                <button class="btn btn-secondary" @onclick="ClearResults" disabled="@(StateService.IsRunning || isInitializing || isRefreshingParameters)">
                    üóëÔ∏è Clear Results
                </button>
                <button class="btn btn-secondary" @onclick="RefreshSearchParameters" disabled="@(StateService.IsRunning || isInitializing || isRefreshingParameters)">
                    @if (isRefreshingParameters)
                    {
                        <span>‚è≥ Refreshing...</span>
                    }
                    else
                    {
                        <span>üîÑ Refresh Parameters</span>
                    }
                </button>
                @if (StateService.CachedSearchParameters != null && StateService.CachedSearchParameters.Any())
                {
                    <div style="padding: 8px 12px; background-color: #e8f4fd; border-radius: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;">
                        <span><strong>Cached:</strong> @StateService.CachedSearchParameters.Count parameters (ShardId: @StateService.CachedShardId)</span>
                        <a href="/parameters" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">View ‚Üí</a>
                    </div>
                }
            </div>
        </div>

        <div class="card">
            <h2>Search Services</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Enable or disable search services for the comparison run</p>
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <button class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px;" @onclick="EnableAllServices" disabled="@(StateService.IsRunning || isInitializing)">
                    ‚úì Enable All
                </button>
                <button class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px;" @onclick="DisableAllServices" disabled="@(StateService.IsRunning || isInitializing)">
                    ‚úó Disable All
                </button>
            </div>
            <div class="services-grid" style="grid-template-columns: repeat(2, 1fr); max-height: 280px; overflow-y: auto;">
                @foreach (var serviceName in GetAllSearchServices())
                {
                    var isEnabled = Config.EnabledSearchServices.Contains(serviceName);
                    <div class="service-toggle">
                        <label>
                            <input type="checkbox" 
                                   checked="@isEnabled" 
                                   @onchange="@((e) => ToggleService(serviceName, (bool)(e.Value ?? false)))"
                                   disabled="@(StateService.IsRunning || isInitializing)" />
                            <span class="@(isEnabled ? "service-enabled" : "service-disabled")">@serviceName</span>
                        </label>
                    </div>
                }
            </div>
            <div style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px;">
                <strong>Enabled:</strong> @Config.EnabledSearchServices.Count of @GetAllSearchServices().Count
            </div>
        </div>
    </div>

    @if (StateService.IsRunning || StateService.Total > 0 || isInitializing)
    {
        <div class="card">
            <h2>Progress</h2>
            <div class="progress-container">
                @if (isInitializing)
                {
                    <div style="text-align: center; padding: 20px;">
                        <div class="spinner"></div>
                        <p style="color: var(--primary-color); font-weight: 500;">@initializationMessage</p>
                    </div>
                }
                else
                {
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: @GetProgressPercentage()%">
                            @StateService.Current / @StateService.Total
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: #666;">@StateService.Message</p>
                }
            </div>
        </div>
    }

    @if (StateService.Results.Any())
    {
        var resultsSnapshot = StateService.Results.ToList(); // Create a snapshot for rendering
        var matchedCount = resultsSnapshot.Count(r => r.Matched);
        var matchedOnRetryCount = resultsSnapshot.Count(r => !r.Matched && r.RetryMatched == true);
        var confirmedMismatchCount = resultsSnapshot.Count(r => !r.Matched && (r.RetryMatched == false || r.RetryMatched == null));
        var totalMatched = matchedCount + matchedOnRetryCount; // Include transient mismatches as "matched"
        
        // Calculate result-based metrics (total individual results that matched vs total results)
        // For effective matches (including matched-on-retry), InBoth/OnlyIn* lists are empty ‚Äî use ControlCount instead
        var totalMatchedResults = resultsSnapshot.Sum(r => IsEffectiveMatch(r) ? (r.RetryControlCount ?? r.ControlCount) : r.InBoth.Count);
        var totalResults = resultsSnapshot.Sum(r => IsEffectiveMatch(r) 
            ? (r.RetryControlCount ?? r.ControlCount) 
            : r.InBoth.Count + r.OnlyInControl.Count + r.OnlyInTest.Count);
        
        // Data movement tracking
        var totalIgnoredFromControl = resultsSnapshot.Sum(r => r.IgnoredFromControl.Count);
        var totalIgnoredFromTest = resultsSnapshot.Sum(r => r.IgnoredFromTest.Count);
        var totalIgnored = totalIgnoredFromControl + totalIgnoredFromTest;
        var matchedDueToIgnoring = resultsSnapshot.Count(r => IsEffectiveMatch(r) && (r.IgnoredFromControl.Any() || r.IgnoredFromTest.Any()));
        
        // Calculate mismatches by ResultSlotType (with contributing search detail) ‚Äî confirmed only
        var mismatchedResults = resultsSnapshot.Where(r => !r.Matched && r.RetryMatched != true).ToList();
        var slotTypeBreakdown = new Dictionary<string, int>();
        var slotTypeContributors = new Dictionary<string, List<(ComparisonResult Result, int OnlyControlCount, int OnlyTestCount)>>();
        
        foreach (var result in mismatchedResults)
        {
            // Count mismatches from OnlyInControl
            foreach (var kvp in result.OnlyInControlBySlotType)
            {
                if (!slotTypeBreakdown.ContainsKey(kvp.Key))
                {
                    slotTypeBreakdown[kvp.Key] = 0;
                    slotTypeContributors[kvp.Key] = new();
                }
                slotTypeBreakdown[kvp.Key] += kvp.Value.Count;
            }
            
            // Count mismatches from OnlyInTest
            foreach (var kvp in result.OnlyInTestBySlotType)
            {
                if (!slotTypeBreakdown.ContainsKey(kvp.Key))
                {
                    slotTypeBreakdown[kvp.Key] = 0;
                    slotTypeContributors[kvp.Key] = new();
                }
                slotTypeBreakdown[kvp.Key] += kvp.Value.Count;
            }
            
            // Build contributor entries per slot type
            var allSlotTypes = result.OnlyInControlBySlotType.Keys
                .Union(result.OnlyInTestBySlotType.Keys)
                .Distinct();
            foreach (var slotType in allSlotTypes)
            {
                var onlyControlCount = result.OnlyInControlBySlotType.TryGetValue(slotType, out var oc) ? oc.Count : 0;
                var onlyTestCount = result.OnlyInTestBySlotType.TryGetValue(slotType, out var ot) ? ot.Count : 0;
                if (onlyControlCount > 0 || onlyTestCount > 0)
                {
                    if (!slotTypeContributors.ContainsKey(slotType))
                        slotTypeContributors[slotType] = new();
                    slotTypeContributors[slotType].Add((result, onlyControlCount, onlyTestCount));
                }
            }
        }
        
        <div class="card">
            <h2>Summary</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Total Comparisons</h3>
                    <p class="value">@resultsSnapshot.Count</p>
                </div>
                <div class="summary-card success">
                    <h3>Matched</h3>
                    <p class="value" style="color: var(--success-color);">@totalMatched</p>
                    @if (matchedOnRetryCount > 0)
                    {
                        <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">(@matchedOnRetryCount transient)</p>
                    }
                </div>
                <div class="summary-card danger">
                    <h3>Confirmed Mismatches</h3>
                    <p class="value" style="color: var(--danger-color);">@confirmedMismatchCount</p>
                </div>
                <div class="summary-card">
                    <h3>Search Success Rate</h3>
                    <p class="value">@GetSuccessRate(totalMatched, resultsSnapshot.Count)%</p>
                </div>
                <div class="summary-card">
                    <h3>Result Match Rate</h3>
                    <p class="value">@GetSuccessRate(totalMatchedResults, totalResults)%</p>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">@totalMatchedResults.ToString("N0") / @totalResults.ToString("N0") results</p>
                </div>
                @if (totalIgnored > 0)
                {
                    <div class="summary-card" style="border-left: 3px solid #ff9800;">
                        <h3>Ignored (Data Movement)</h3>
                        <p class="value" style="color: #ff9800;">@totalIgnored</p>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            @totalIgnoredFromControl from Control, @totalIgnoredFromTest from Test
                            @if (matchedDueToIgnoring > 0)
                            {
                                <br /><span>@matchedDueToIgnoring search(es) became matches</span>
                            }
                        </p>
                    </div>
                }
            </div>
        </div>

        @if (slotTypeBreakdown.Any())
        {
            <div class="card">
                <h2>Mismatches by ResultSlotType</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">
                    Breakdown of mismatched results by their slot type ‚Äî click a card to see contributing searches
                </p>
                <div class="summary-grid">
                    @foreach (var kvp in slotTypeBreakdown.OrderByDescending(x => x.Value))
                    {
                        var slotKey = kvp.Key;
                        var isSelected = selectedSlotType == slotKey;
                        <div class="summary-card slot-card @(isSelected ? "slot-card-selected" : "")" 
                             @onclick="@(() => ToggleSlotType(slotKey))"
                             title="Click to see contributing searches">
                            <h3>@FormatSlotType(kvp.Key)</h3>
                            <p class="value" style="color: var(--danger-color);">@kvp.Value.ToString("N0")</p>
                            <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">mismatched results</p>
                        </div>
                    }
                </div>

                @if (selectedSlotType != null && slotTypeContributors.TryGetValue(selectedSlotType, out var contributors))
                {
                    <div class="slot-detail-panel">
                        <h3 style="margin: 0 0 12px 0; color: var(--primary-color);">
                            Searches contributing to <strong>@FormatSlotType(selectedSlotType)</strong> mismatches
                            <span style="font-weight: 400; font-size: 0.85rem; color: #666;"> ‚Äî @contributors.Count search(es)</span>
                        </h3>
                        <table class="results-table" style="margin-top: 0;">
                            <thead>
                                <tr>
                                    <th>Search Service</th>
                                    <th>Searcher User ID</th>
                                    <th>Site Code</th>
                                    <th>Only in Control</th>
                                    <th>Only in Test</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var c in contributors.OrderByDescending(c => c.OnlyControlCount + c.OnlyTestCount))
                                {
                                    <tr>
                                        <td><span class="service-badge">@c.Result.SearchServiceName</span></td>
                                        <td>
                                            <strong>@c.Result.SearcherUserId</strong>
                                            <br />
                                            <a href="/parameters?filter=@c.Result.SearcherUserId"
                                               style="font-size: 0.8rem; color: var(--primary-color); text-decoration: none;"
                                               title="View search parameters for this user">
                                                üìã Params
                                            </a>
                                        </td>
                                        <td>@c.Result.SiteCode</td>
                                        <td style="color: var(--danger-color); font-weight: 600;">@c.OnlyControlCount</td>
                                        <td style="color: var(--primary-color); font-weight: 600;">@c.OnlyTestCount</td>
                                        <td>
                                            @if (c.Result.WasRetried && c.Result.RetryMatched == false)
                                            {
                                                <span class="badge badge-danger">üîÅ Confirmed</span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-danger">‚úó Diff</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Results</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="font-weight: 500; color: #666;">Group by:</label>
                    <button class="btn @(groupByService ? "btn-primary" : "btn-secondary")" 
                            style="font-size: 0.9rem; padding: 8px 16px;" 
                            @onclick="@(() => groupByService = true)">
                        üîç Search Service
                    </button>
                    <button class="btn @(!groupByService ? "btn-primary" : "btn-secondary")" 
                            style="font-size: 0.9rem; padding: 8px 16px;" 
                            @onclick="@(() => groupByService = false)">
                        üìç Site Code
                    </button>
                </div>
            </div>
            
            <div class="filter-bar">
                <input type="text" class="search-input" placeholder="Filter by SiteCode or SearcherUserId..." @bind="filterText" @bind:event="oninput" />
                <select @bind="filterStatus" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <option value="mismatched">Mismatched Only</option>
                    <option value="all">All Results</option>
                    <option value="matched">Matched Only</option>
                </select>
            </div>

            @if (groupByService)
            {
                @foreach (var serviceGroup in GetFilteredGroupedByService())
                {
                    var displayed = serviceGroup.Count();
                    var allForService = StateService.Results.Where(r => r.SearchServiceName == serviceGroup.Key);
                    var serviceMatched = allForService.Count(r => IsEffectiveMatch(r));
                    var serviceMismatched = allForService.Count(r => !IsEffectiveMatch(r));

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                            üîç @serviceGroup.Key ‚Äî 
                            <span style="color: var(--success-color);">@serviceMatched matched</span> / 
                            <span style="color: var(--danger-color);">@serviceMismatched mismatched</span>
                            @if (filterStatus != "all")
                            {
                                <span style="color: #888; font-size: 0.85rem; font-weight: normal;">(showing @displayed @filterStatus below)</span>
                            }
                        </h3>
                        
                        @foreach (var siteGroup in serviceGroup.GroupBy(r => r.SiteCode).OrderBy(g => g.Key))
                        {
                            var siteDisplayed = siteGroup.Count();
                            var allForServiceSite = StateService.Results.Where(r => r.SearchServiceName == serviceGroup.Key && r.SiteCode == siteGroup.Key);
                            var siteMatchedTotal = allForServiceSite.Count(r => IsEffectiveMatch(r));
                            var siteMismatchedTotal = allForServiceSite.Count(r => !IsEffectiveMatch(r));

                            <div style="margin-left: 20px; margin-bottom: 20px;">
                                <h4 style="color: #666; margin-bottom: 10px; font-size: 1rem;">
                                    üìç SiteCode: @siteGroup.Key ‚Äî 
                                    <span style="color: var(--success-color);">@siteMatchedTotal matched</span> / 
                                    <span style="color: var(--danger-color);">@siteMismatchedTotal mismatched</span>
                                    @if (filterStatus != "all")
                                    {
                                        <span style="color: #888; font-size: 0.8rem; font-weight: normal;">(showing @siteDisplayed)</span>
                                    }
                                </h4>
                                
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Searcher User ID</th>
                                            <th>Control Count</th>
                                            <th>Test Count</th>
                                            <th>Call ID</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var result in siteGroup.OrderBy(r => IsEffectiveMatch(r)).ThenBy(r => r.SearcherUserId))
                                        {
                                            <tr>
                                                <td>
                                                    @if (result.Matched)
                                                    {
                                                        <span class="badge badge-success">‚úì Match</span>
                                                    }
                                                    else if (result.RetryMatched == true)
                                                    {
                                                        <span class="badge badge-success" title="Mismatch on first run, but matched on retry - transient">‚úì Match <span style="font-size: 0.75rem;">(on retry)</span></span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-danger">‚úó Diff</span>
                                                        @if (result.WasRetried && result.RetryMatched == false)
                                                        {
                                                            <span class="badge badge-danger" style="margin-left: 5px;" title="Mismatch confirmed on retry">üîÅ Confirmed</span>
                                                        }
                                                    }
                                                </td>
                                                <td>
                                                    <strong>@result.SearcherUserId</strong>
                                                    <br />
                                                    <a href="/parameters?filter=@result.SearcherUserId" 
                                                       style="font-size: 0.8rem; color: var(--primary-color); text-decoration: none;"
                                                       title="View search parameters for this user">
                                                        üìã Params
                                                    </a>
                                                </td>
                                                <td>
                                                    @result.ControlCount
                                                    @if (result.WasRetried && result.RetryControlCount.HasValue)
                                                    {
                                                        <span style="color: #666; font-size: 0.85rem;"> ‚Üí @result.RetryControlCount</span>
                                                    }
                                                </td>
                                                <td>
                                                    @result.TestCount
                                                    @if (result.WasRetried && result.RetryTestCount.HasValue)
                                                    {
                                                        <span style="color: #666; font-size: 0.85rem;"> ‚Üí @result.RetryTestCount</span>
                                                    }
                                                </td>
                                                <td style="font-family: monospace; font-size: 0.85rem;">
                                                    @if (!IsEffectiveMatch(result) && result.RetryMatched == false)
                                                    {
                                                        <div style="display: flex; flex-direction: column; gap: 4px;">
                                                            <a href="http://@Config.MrSixControl:8888/admin/getExplain?callid=@result.ControlCallId" 
                                                               target="_blank" 
                                                               style="color: #0066cc; text-decoration: none; font-size: 0.85rem;"
                                                               title="View explain on Control server (@result.ControlCallId)">
                                                                üìä Control
                                                            </a>
                                                            <a href="http://@Config.MrSixTest:8888/admin/getExplain?callid=@result.TestCallId" 
                                                               target="_blank" 
                                                               style="color: #0066cc; text-decoration: none; font-size: 0.85rem;"
                                                               title="View explain on Test server (@result.TestCallId)">
                                                                üìä Test
                                                            </a>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span style="color: #999;">N/A</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (!IsEffectiveMatch(result))
                                                    {
                                                        <div class="diff-details">
                                                            @if (result.OnlyInControl.Any())
                                                            {
                                                                <div class="diff-section">
                                                                    <strong style="color: var(--danger-color);">Only in Control (@result.OnlyInControl.Count):</strong>
                                                                    <span>@RenderUserIdLinks(result.OnlyInControl)</span>
                                                                </div>
                                                            }
                                                            @if (result.OnlyInTest.Any())
                                                            {
                                                                <div class="diff-section">
                                                                    <strong style="color: var(--primary-color);">Only in Test (@result.OnlyInTest.Count):</strong>
                                                                    <span>@RenderUserIdLinks(result.OnlyInTest)</span>
                                                                </div>
                                                            }
                                                            @if (result.InBoth.Any())
                                                            {
                                                                <div class="diff-section">
                                                                    <strong style="color: var(--success-color);">In Both (@result.InBoth.Count):</strong>
                                                                    <span>@RenderUserIdLinks(result.InBoth)</span>
                                                                </div>
                                                            }
                                                            @if (result.IgnoredFromControl.Any() || result.IgnoredFromTest.Any())
                                                            {
                                                                <div class="diff-section" style="opacity: 0.7;">
                                                                    <strong style="color: #ff9800;">Ignored - Data Movement (@(result.IgnoredFromControl.Count + result.IgnoredFromTest.Count)):</strong>
                                                                    @if (result.IgnoredFromControl.Any())
                                                                    {
                                                                        <span> Control: @RenderUserIdLinks(result.IgnoredFromControl)</span>
                                                                    }
                                                                    @if (result.IgnoredFromTest.Any())
                                                                    {
                                                                        <span> Test: @RenderUserIdLinks(result.IgnoredFromTest)</span>
                                                                    }
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                    else if (result.IgnoredFromControl.Any() || result.IgnoredFromTest.Any())
                                                    {
                                                        <div class="diff-details" style="opacity: 0.7;">
                                                            <div class="diff-section">
                                                                <strong style="color: #ff9800;">Ignored - Data Movement (@(result.IgnoredFromControl.Count + result.IgnoredFromTest.Count)):</strong>
                                                                @if (result.IgnoredFromControl.Any())
                                                                {
                                                                    <span> Control: @RenderUserIdLinks(result.IgnoredFromControl)</span>
                                                                }
                                                                @if (result.IgnoredFromTest.Any())
                                                                {
                                                                    <span> Test: @RenderUserIdLinks(result.IgnoredFromTest)</span>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span style="color: #999;">No differences</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                @foreach (var siteGroup in GetFilteredGroupedBySiteCode())
                {
                    var displayed = siteGroup.Count();
                    var allForSite = StateService.Results.Where(r => r.SiteCode == siteGroup.Key);
                    var siteMatchedTotal = allForSite.Count(r => IsEffectiveMatch(r));
                    var siteMismatchedTotal = allForSite.Count(r => !IsEffectiveMatch(r));

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                            üìç SiteCode: @siteGroup.Key ‚Äî 
                            <span style="color: var(--success-color);">@siteMatchedTotal matched</span> / 
                            <span style="color: var(--danger-color);">@siteMismatchedTotal mismatched</span>
                            @if (filterStatus != "all")
                            {
                                <span style="color: #888; font-size: 0.85rem; font-weight: normal;">(showing @displayed @filterStatus below)</span>
                            }
                        </h3>
                        
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Search Service</th>
                                    <th>Searcher User ID</th>
                                    <th>Control Count</th>
                                    <th>Test Count</th>
                                    <th>Call ID</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var result in siteGroup.OrderBy(r => IsEffectiveMatch(r)).ThenBy(r => r.SearcherUserId))
                                {
                                    <tr>
                                        <td>
                                            @if (result.Matched)
                                            {
                                                <span class="badge badge-success">‚úì Match</span>
                                            }
                                            else if (result.RetryMatched == true)
                                            {
                                                <span class="badge badge-success" title="Mismatch on first run, but matched on retry - transient">‚úì Match <span style="font-size: 0.75rem;">(on retry)</span></span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-danger">‚úó Diff</span>
                                                @if (result.WasRetried && result.RetryMatched == false)
                                                {
                                                    <span class="badge badge-danger" style="margin-left: 5px;" title="Mismatch confirmed on retry">üîÅ Confirmed</span>
                                                }
                                            }
                                        </td>
                                        <td><span class="service-badge">@result.SearchServiceName</span></td>
                                        <td>
                                            <strong>@result.SearcherUserId</strong>
                                            <br />
                                            <a href="/parameters?filter=@result.SearcherUserId" 
                                               style="font-size: 0.8rem; color: var(--primary-color); text-decoration: none;"
                                               title="View search parameters for this user">
                                                üìã Params
                                            </a>
                                        </td>
                                        <td>
                                            @result.ControlCount
                                            @if (result.WasRetried && result.RetryControlCount.HasValue)
                                            {
                                                <span style="color: #666; font-size: 0.85rem;"> ‚Üí @result.RetryControlCount</span>
                                            }
                                        </td>
                                        <td>
                                            @result.TestCount
                                            @if (result.WasRetried && result.RetryTestCount.HasValue)
                                            {
                                                <span style="color: #666; font-size: 0.85rem;"> ‚Üí @result.RetryTestCount</span>
                                            }
                                        </td>
                                        <td style="font-family: monospace; font-size: 0.85rem;">
                                            @if (!IsEffectiveMatch(result) && result.RetryMatched == false)
                                            {
                                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                                    <a href="http://@Config.MrSixControl:8888/admin/getExplain?callid=@result.ControlCallId" 
                                                       target="_blank" 
                                                       style="color: #0066cc; text-decoration: none; font-size: 0.85rem;"
                                                       title="View explain on Control server (@result.ControlCallId)">
                                                        üìä Control
                                                    </a>
                                                    <a href="http://@Config.MrSixTest:8888/admin/getExplain?callid=@result.TestCallId" 
                                                       target="_blank" 
                                                       style="color: #0066cc; text-decoration: none; font-size: 0.85rem;"
                                                       title="View explain on Test server (@result.TestCallId)">
                                                        üìä Test
                                                    </a>
                                                </div>
                                            }
                                            else
                                            {
                                                <span style="color: #999;">N/A</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!IsEffectiveMatch(result))
                                            {
                                                <div class="diff-details">
                                                    @if (result.OnlyInControl.Any())
                                                    {
                                                        <div class="diff-section">
                                                            <strong style="color: var(--danger-color);">Only in Control (@result.OnlyInControl.Count):</strong>
                                                            <span>@RenderUserIdLinks(result.OnlyInControl)</span>
                                                        </div>
                                                    }
                                                    @if (result.OnlyInTest.Any())
                                                    {
                                                        <div class="diff-section">
                                                            <strong style="color: var(--primary-color);">Only in Test (@result.OnlyInTest.Count):</strong>
                                                            <span>@RenderUserIdLinks(result.OnlyInTest)</span>
                                                        </div>
                                                    }
                                                    @if (result.InBoth.Any())
                                                    {
                                                        <div class="diff-section">
                                                            <strong style="color: var(--success-color);">In Both (@result.InBoth.Count):</strong>
                                                            <span>@RenderUserIdLinks(result.InBoth)</span>
                                                        </div>
                                                    }
                                                    @if (result.IgnoredFromControl.Any() || result.IgnoredFromTest.Any())
                                                    {
                                                        <div class="diff-section" style="opacity: 0.7;">
                                                            <strong style="color: #ff9800;">Ignored - Data Movement (@(result.IgnoredFromControl.Count + result.IgnoredFromTest.Count)):</strong>
                                                            @if (result.IgnoredFromControl.Any())
                                                            {
                                                                <span> Control: @RenderUserIdLinks(result.IgnoredFromControl)</span>
                                                            }
                                                            @if (result.IgnoredFromTest.Any())
                                                            {
                                                                <span> Test: @RenderUserIdLinks(result.IgnoredFromTest)</span>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else if (result.IgnoredFromControl.Any() || result.IgnoredFromTest.Any())
                                            {
                                                <div class="diff-details" style="opacity: 0.7;">
                                                    <div class="diff-section">
                                                        <strong style="color: #ff9800;">Ignored - Data Movement (@(result.IgnoredFromControl.Count + result.IgnoredFromTest.Count)):</strong>
                                                        @if (result.IgnoredFromControl.Any())
                                                        {
                                                            <span> Control: @RenderUserIdLinks(result.IgnoredFromControl)</span>
                                                        }
                                                        @if (result.IgnoredFromTest.Any())
                                                        {
                                                            <span> Test: @RenderUserIdLinks(result.IgnoredFromTest)</span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <span style="color: #999;">No differences</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        </div>
    }

    @if (errorMessage != null)
    {
        <div class="card" style="border-left: 4px solid var(--danger-color);">
            <h2 style="color: var(--danger-color);">Error</h2>
            <p>@errorMessage</p>
        </div>
    }
</div>

@code {
    private string? errorMessage;
    private string filterText = "";
    private string filterStatus = "mismatched"; // Default to showing mismatches only
    private bool groupByService = true; // Default to grouping by service
    private bool isInitializing = false;
    private bool isRefreshingParameters = false;
    private string initializationMessage = "";
    private CancellationTokenSource? _cts;
    private string? selectedSlotType;
    private List<string> allSearchServices = new List<string>
    {
        "Stack",
        "SearchV4.OnePush",
        "SearchV4.TwoWay",
        "SearchV4.Reverse",
        "SearchV4.MoreLikeThis",
        "SearchV4.OneWay",
        "SearchV4.SearchWow",
        "SearchHighlight.LitBatch",
        "SearchHighlight.LitSearch",
        "SearchV4.Recommended.ExpertPicks",
        "SearchV4.Recommended.JustForYou",
        "SearchV4.Recommended.MatchPicks"
    };

    protected override void OnInitialized()
    {
        StateService.StateChanged += OnStateChanged;
        LoggingService.Initialize(Config);
    }

    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private List<string> GetAllSearchServices()
    {
        return allSearchServices;
    }

    private void ToggleService(string serviceName, bool isEnabled)
    {
        if (isEnabled)
        {
            Config.EnabledSearchServices.Add(serviceName);
        }
        else
        {
            Config.EnabledSearchServices.Remove(serviceName);
        }
        StateHasChanged();
    }

    private void EnableAllServices()
    {
        foreach (var service in allSearchServices)
        {
            Config.EnabledSearchServices.Add(service);
        }
        StateHasChanged();
    }

    private void DisableAllServices()
    {
        Config.EnabledSearchServices.Clear();
        StateHasChanged();
    }

    private async Task RefreshSearchParameters()
    {
        try
        {
            isRefreshingParameters = true;
            errorMessage = null;
            await InvokeAsync(StateHasChanged);
            await Task.Delay(50);

            // Validate and get ShardId
            var shardId = await Task.Run(() => 
                ShardValidationService.ValidateAndGetShardId(Config.MrSixControl, Config.MrSixTest));
            
            // Get search parameters from database
            var searchParameters = await Task.Run(() => 
                SearchParameterService.GetSearchParameters(shardId));
            
            StateService.SetCachedSearchParameters(searchParameters, shardId);
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error refreshing parameters: {ex.Message}";
            StateService.SetCachedSearchParameters(null!, 0);
        }
        finally
        {
            isRefreshingParameters = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StartComparison()
    {
        _cts?.Dispose();
        _cts = new CancellationTokenSource();
        var cancellationToken = _cts.Token;

        try
        {
            errorMessage = null;
            StateService.ClearResults();
            
            // Set initializing state and force UI update
            isInitializing = true;
            initializationMessage = "Starting comparison...";
            await InvokeAsync(StateHasChanged);
            await Task.Delay(50); // Allow UI to update
            
            StateService.SetRunning(true);
            StateService.SetProgress(0, 0, "Initializing...");

            // Check if we need to load search parameters
            if (StateService.CachedSearchParameters == null || !StateService.CachedSearchParameters.Any())
            {
                // Validate and get ShardId - run in background to not block UI
                initializationMessage = "Validating shard configuration...";
                await InvokeAsync(StateHasChanged);
                await Task.Delay(50);
                
                var shardId = await Task.Run(() => 
                    ShardValidationService.ValidateAndGetShardId(Config.MrSixControl, Config.MrSixTest), cancellationToken);
                
                // Get search parameters - this is the slow operation
                initializationMessage = $"Loading search parameters from database (ShardId: {shardId})...";
                await InvokeAsync(StateHasChanged);
                await Task.Delay(50);
                
                var searchParameters = await Task.Run(() => 
                    SearchParameterService.GetSearchParameters(shardId), cancellationToken);
                
                StateService.SetCachedSearchParameters(searchParameters, shardId);
            }
            else
            {
                initializationMessage = $"Using cached search parameters ({StateService.CachedSearchParameters.Count} loaded, ShardId: {StateService.CachedShardId})...";
                await InvokeAsync(StateHasChanged);
                await Task.Delay(50);
            }
            
            cancellationToken.ThrowIfCancellationRequested();
            
            // Clear initializing state
            isInitializing = false;
            
            if (StateService.CachedSearchParameters == null || !StateService.CachedSearchParameters.Any())
            {
                throw new InvalidOperationException("Failed to load search parameters");
            }
            
            StateService.SetProgress(0, StateService.CachedSearchParameters.Count, $"Loaded {StateService.CachedSearchParameters.Count} search parameters");

            // Execute comparisons
            var comparisonService = new ComparisonService(
                Config, 
                StackSearchService,
                OnePushService,
                LitBatchService,
                LitSearchService,
                MoreLikeThisService,
                OneWayService,
                ExpertPicksService,
                JustForYouService,
                MatchPicksService,
                ReverseService,
                SearchWowService,
                TwoWayService);
            
            // Wire up events
            comparisonService.ProgressUpdated += (sender, args) =>
            {
                StateService.SetProgress(args.Current, args.Total, args.Message);
            };

            comparisonService.ComparisonCompleted += (sender, args) =>
            {
                StateService.AddResult(args.Result);
            };

            await comparisonService.CompareSearchResults(StateService.CachedSearchParameters, cancellationToken);
            
            StateService.SetProgress(StateService.CachedSearchParameters.Count, StateService.CachedSearchParameters.Count, "Comparison complete!");
        }
        catch (OperationCanceledException)
        {
            var completed = StateService.Current;
            StateService.SetProgress(completed, StateService.Total, $"Cancelled after {completed} of {StateService.Total} comparisons.");
            isInitializing = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error during comparison: {ex.Message}";
            isInitializing = false;
        }
        finally
        {
            StateService.SetRunning(false);
            isInitializing = false;
            await LoggingService.CloseAndFlush();
        }
    }

    private void CancelComparison()
    {
        _cts?.Cancel();
    }

    private void ClearResults()
    {
        StateService.ClearResults();
        selectedSlotType = null;
        errorMessage = null;
    }

    private void ToggleSlotType(string slotType)
    {
        selectedSlotType = selectedSlotType == slotType ? null : slotType;
    }

    private double GetProgressPercentage()
    {
        if (StateService.Total == 0) return 0;
        return (double)StateService.Current / StateService.Total * 100;
    }

    private MarkupString RenderUserIdLinks(List<int> userIds, int max = 10)
    {
        var links = userIds.Take(max).Select(id =>
            $"<a href=\"https://kraken.i.mct360.com/six/UserInfo/{id}/{Config.MrSixControl},{Config.MrSixTest}\" target=\"_blank\" style=\"color: inherit; text-decoration: underline dotted; text-underline-offset: 2px;\" title=\"View {id} in Kraken\">{id}</a>");
        var result = string.Join(", ", links);
        if (userIds.Count > max)
            result += "...";
        return new MarkupString(result);
    }

    /// <summary>
    /// A result is effectively matched if it matched outright, or if it matched on retry (transient).
    /// </summary>
    private static bool IsEffectiveMatch(ComparisonResult r) => r.Matched || r.RetryMatched == true;

    private string GetSuccessRate(int matchedCount, int totalCount)
    {
        if (totalCount == 0) return "0.0";
        var rate = (double)matchedCount / totalCount * 100;
        return rate.ToString("F1");
    }

    private IEnumerable<IGrouping<string, ComparisonResult>> GetFilteredGroupedByService()
    {
        var results = StateService.Results.ToList(); // Create a snapshot
        var filtered = results.AsEnumerable();

        // Apply status filter
        if (filterStatus == "matched")
            filtered = filtered.Where(r => IsEffectiveMatch(r));
        else if (filterStatus == "mismatched")
            filtered = filtered.Where(r => !IsEffectiveMatch(r));

        // Apply text filter
        if (!string.IsNullOrWhiteSpace(filterText))
        {
            filtered = filtered.Where(r => 
                r.SiteCode.ToString().Contains(filterText, StringComparison.OrdinalIgnoreCase) ||
                r.SearcherUserId.ToString().Contains(filterText, StringComparison.OrdinalIgnoreCase));
        }

        return filtered.GroupBy(r => r.SearchServiceName).OrderBy(g => g.Key);
    }

    private IEnumerable<IGrouping<short, ComparisonResult>> GetFilteredGroupedBySiteCode()
    {
        var results = StateService.Results.ToList(); // Create a snapshot
        var filtered = results.AsEnumerable();

        // Apply status filter
        if (filterStatus == "matched")
            filtered = filtered.Where(r => IsEffectiveMatch(r));
        else if (filterStatus == "mismatched")
            filtered = filtered.Where(r => !IsEffectiveMatch(r));

        // Apply text filter
        if (!string.IsNullOrWhiteSpace(filterText))
        {
            filtered = filtered.Where(r => 
                r.SiteCode.ToString().Contains(filterText, StringComparison.OrdinalIgnoreCase) ||
                r.SearcherUserId.ToString().Contains(filterText, StringComparison.OrdinalIgnoreCase));
        }

        return filtered.GroupBy(r => r.SiteCode).OrderBy(g => g.Key);
    }

    private static readonly Dictionary<int, string> AlgoIdNames = new()
    {
        [0] = "Default", [1] = "Yml", [2] = "Mlt", [3] = "TopSpotPaid", [4] = "TopSpotGifted",
        [5] = "VenusBackfill0", [6] = "VenusBackfill1", [7] = "VenusBackfill2", [8] = "VenusBackfill3",
        [9] = "VenusBackfill4", [10] = "VenusBackfill5", [11] = "VenusBackfill6", [12] = "VenusBackfill7",
        [13] = "VenusBackfill8", [14] = "VenusBackfill9", [15] = "VenusBackfill10",
        [140] = "ExpertLikedMe", [141] = "ExpertMLMutualMatches", [142] = "ExpertTriangulationByEmailResponses",
        [143] = "ExpertTriangulationByEmail", [144] = "ExpertTriangulationByLikes",
        [145] = "ExpertAmarnathBoratWithCap", [146] = "ExpertMutualMatch151",
        [147] = "ExpertNotUsedYet1", [148] = "ExpertNotUsedYet2", [149] = "ExpertNotUsedYet3",
        [150] = "MbuTriangulationByEmailResponses", [151] = "MbuTriangulationByEmail",
        [152] = "MbuTriangulationByLikes", [153] = "MbuAmarnathBoratWithCap", [154] = "MbuMutualMatch151",
        [155] = "MbuMorePie", [156] = "ReactivationJfy", [157] = "ReactivationMp", [158] = "ReactivationOp",
        [165] = "WowSearchNewMember", [166] = "WowSearchPopular",
        [171] = "VenusTriangulation171", [172] = "MM172", [174] = "MMsearch174",
        [175] = "SingledOut175", [176] = "SingledOut176", [177] = "MMbanding177",
        [179] = "ML179", [180] = "FirstSetOfJfy", [181] = "FirstSetOfMp", [182] = "MLMutualMatches",
        [183] = "LitTwoWay", [184] = "PtrMp",
        [190] = "LitTriangulationByEmail", [191] = "LitTriangulationByLikes",
        [192] = "LitTriangulationByEmailResponses", [193] = "LitMorePie",
        [194] = "LitRelationshipIntent", [195] = "LitCoreValue", [196] = "LitCurrentSubs",
        [197] = "LitAffinity", [198] = "LitMeeticPopular", [199] = "LitMeeticRelevant",
        [200] = "VenusJfy171Email", [201] = "VenusJfy171Likes", [251] = "VenusJfySeeds",
        [204] = "BatchSearch", [205] = "FlyBy", [206] = "G3Spotlight", [207] = "NewMembers",
        [208] = "OneWay", [209] = "OneWayApi", [210] = "Reverse", [211] = "Keyword",
        [212] = "TopSpotBackfill", [213] = "TwoWay", [214] = "MakeMatchesJfy", [215] = "MakeMatchesMp",
        [216] = "PriorityLikeResultAlgoId",
        [272] = "LikedMeInMatchPicks", [273] = "LikedMeInJustForYou", [274] = "LikedMeInYouMightLike",
        [275] = "SuperLikeInMatchPicks", [276] = "SuperLikeInJustForYou", [277] = "SuperLikeInYouMightLike",
        [278] = "MorePieJfy", [279] = "MorePieMp", [280] = "MorePieOneP",
        [300] = "MpV2Mlt", [301] = "MpV2175", [302] = "MpV2171Email", [303] = "MpV2171Likes",
        [371] = "VenusTriangulation171FpV3", [372] = "MM172FpV3", [374] = "MMsearch174FpV3",
        [375] = "SingledOut175FpV3", [376] = "SingledOut176FpV3", [377] = "MMbanding177FpV3",
        [379] = "ML179FpV3", [380] = "FirstSetOfJfyFpV3", [381] = "FirstSetOfMpFpV3",
        [382] = "LikedMeInJustForYouFpV3", [383] = "SuperLikeInJustForYouFpV3",
        [384] = "LikedMeInMatchPickesFpV3", [385] = "SuperLikeInMatchPickesFpV3",
        [386] = "EuclidDistanceMp", [387] = "EuclidDistanceJfy",
        [388] = "EuclidDistanceMpFpV3", [389] = "EuclidDistanceJfyFpV3",
        [400] = "HomeTown", [401] = "College", [402] = "CollegeHomeTown",
        [403] = "MeetIrl", [404] = "StickerSearch",
        [500] = "StackCoreRecent", [501] = "StackCoreAll", [502] = "StackNewUsers",
        [503] = "StackReactivation", [504] = "StackPop180", [505] = "StackSuperLiked",
        [506] = "StackLikedMe", [507] = "StackNewUserLikedMe",
        [508] = "StackTopSpotPaid", [509] = "StackTopSpotGifted",
        [510] = "StackCoreSixty", [511] = "StackPriorityLiked", [512] = "StackPtr",
        [513] = "StackMorePie", [514] = "StackLikeTri", [515] = "StackEmailTri",
        [516] = "StackEmailResponseTri", [517] = "StackTriangulation",
        [518] = "StackCoreNinety", [519] = "StackMorePieSubs", [520] = "StackMorePieTerms",
        [521] = "StackCoreThree", [522] = "StackCoreThirty",
        [530] = "StackCoreRecentPreferred", [531] = "StackCoreAllPreferred",
        [532] = "StackNewUsersPreferred", [533] = "StackReactivationPreferred",
        [534] = "StackPop180Preferred", [535] = "StackSuperLikedPreferred",
        [536] = "StackLikedMePreferred", [537] = "StackNewUserLikedMePreferred",
        [538] = "StackTopSpotPaidPreferred", [539] = "StackTopSpotGiftedPreferred",
        [540] = "StackPriorityLikedPreferred",
        [544] = "StackLikeTriPreferred", [545] = "StackEmailTriPreferred",
        [546] = "StackEmailResponseTriPreferred", [547] = "StackTriangulationPreferred",
        [600] = "MlExperimentMin", [601] = "MlExperimentTwoTowersReranking", [699] = "MlExperimentMax",
        [700] = "StackV2CoreRecent", [701] = "StackV2CoreAll", [702] = "StackV2NewUsers",
        [703] = "StackV2Reactivation", [704] = "StackV2Pop180", [705] = "StackV2SuperLiked",
        [706] = "StackV2LikedMe", [707] = "StackV2NewUserLikedMe",
        [708] = "StackV2TopSpotPaid", [709] = "StackV2TopSpotGifted",
        [710] = "StackV2CoreSixty", [711] = "StackV2PriorityLiked", [712] = "StackV2Ptr",
        [713] = "StackV2MorePie", [714] = "StackV2LikeTri", [715] = "StackV2EmailTri",
        [716] = "StackV2EmailResponseTri", [717] = "StackV2Triangulation",
        [718] = "StackV2CoreNinety", [719] = "StackV2MorePieSubs", [720] = "StackV2MorePieTerms",
        [721] = "StackV2CoreThree", [722] = "StackV2CoreThirty",
        [723] = "StackV2Online", [724] = "StackV2Reborn", [725] = "StackV2RegInHours",
        [1000] = "UNSPECIFIED", [1001] = "RELEVANCE", [1002] = "POPULAR", [1003] = "MESSAGERS",
        [1004] = "SPOTLIGHT", [1005] = "BACKFILL", [1006] = "SPECIAL_EVENT",
        [1007] = "VITALITY_BOOST", [1008] = "LEGACY", [1009] = "NEW_USERS",
        [1010] = "LIKERS", [1011] = "LOW_ATTENTION", [1012] = "STACK_POPULARITY",
        [1013] = "STACK_ONLINE_NOW_POPULARITY", [1014] = "STACK_ONLINE_NOW_RELEVANCE",
        [1015] = "STACK_NEW_FACES_POPULARITY", [1016] = "STACK_MOST_QUESTIONS",
        [1017] = "STACK_NEARBY", [1018] = "STACK_ONLINE_NOW_VITALITY_BOOST",
        [1019] = "STACK_TOP_MATCHES", [1020] = "RANDOM_CURATED", [1021] = "RANDOM_PURE"
    };

    private string FormatSlotType(string slotTypeKey)
    {
        if (int.TryParse(slotTypeKey, out var id) && AlgoIdNames.TryGetValue(id, out var name))
            return $"{name} ({id})";
        return slotTypeKey;
    }

    public void Dispose()
    {
        StateService.StateChanged -= OnStateChanged;
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
