@page "/parameters"
@using MrSixResultsComparator.Core.Models
@using MrSixResultsComparator.BlazorApp.Data
@inject ComparisonStateService StateService
@inject NavigationManager Navigation
@implements IDisposable

<div class="header">
    <div class="container">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="/" style="color: white; text-decoration: none; font-size: 1.5rem;">‚Üê</a>
            <div>
                <h1>Cached Search Parameters</h1>
                <p>View and inspect the cached search parameters from the database</p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    @if (StateService.CachedSearchParameters == null || !StateService.CachedSearchParameters.Any())
    {
        <div class="card">
            <h2>No Parameters Cached</h2>
            <p style="color: #666; margin-bottom: 15px;">No search parameters are currently cached. Run a comparison to load parameters from the database.</p>
            <a href="/" class="btn btn-primary">‚Üê Back to Comparisons</a>
        </div>
    }
    else
    {
        var parameters = StateService.CachedSearchParameters;
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin: 0;">Search Parameters</h2>
                    <p style="color: #666; margin: 5px 0 0 0;">ShardId: @StateService.CachedShardId | Total: @parameters.Count parameters</p>
                </div>
                <a href="/" class="btn btn-secondary">‚Üê Back to Comparisons</a>
            </div>
            
            <div class="filter-bar">
                <input type="text" class="search-input" placeholder="Filter by ClassName, SearcherUserId, SiteCode..." @bind="filterText" @bind:event="oninput" />
                <select @bind="filterClassName" @oninput="OnFilterChanged" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; min-width: 200px;">
                    <option value="">All Services</option>
                    @foreach (var className in GetUniqueClassNames())
                    {
                        <option value="@className">@className</option>
                    }
                </select>
            </div>

            @foreach (var classGroup in GetFilteredGroupedByClassName())
            {
                var groupCount = classGroup.Count();

                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                        üîç @classGroup.Key - @groupCount parameter(s)
                    </h3>
                    
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>SearcherUserId</th>
                                <th>SiteCode</th>
                                <th>Description</th>
                                <th>Request Count</th>
                                <th>Gender/Seek</th>
                                <th>Age Range</th>
                                <th>Call Time</th>
                                <th>CallId</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var param in classGroup.OrderBy(p => p.SiteCode).ThenBy(p => p.SearcherUserId))
                            {
                                <tr>
                                    <td><strong>@param.SearcherUserId</strong></td>
                                    <td>@param.SiteCode</td>
                                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@param.Description">
                                        @(string.IsNullOrEmpty(param.Description) ? "(none)" : param.Description)
                                    </td>
                                    <td>@param.RequestCount</td>
                                    <td>@param.GenderGenderSeek</td>
                                    <td>@param.LAge - @param.UAge</td>
                                    <td style="font-size: 0.85rem;">@param.CallTime.ToString("MM/dd HH:mm:ss")</td>
                                    <td style="font-family: monospace; font-size: 0.85rem;">@param.CallId.ToString().Substring(0, 8)...</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (!GetFilteredGroupedByClassName().Any())
            {
                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>No parameters match your filter criteria.</p>
                </div>
            }
        </div>
    }
</div>

@code {
    private string filterText = "";
    private string filterClassName = "";

    protected override void OnInitialized()
    {
        StateService.StateChanged += OnStateChanged;
    }

    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnFilterChanged(ChangeEventArgs e)
    {
        filterClassName = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private IEnumerable<string> GetUniqueClassNames()
    {
        if (StateService.CachedSearchParameters == null)
            return Enumerable.Empty<string>();

        return StateService.CachedSearchParameters
            .Select(p => p.ClassName)
            .Distinct()
            .OrderBy(c => c);
    }

    private IEnumerable<IGrouping<string, SearchParameter>> GetFilteredGroupedByClassName()
    {
        if (StateService.CachedSearchParameters == null)
            return Enumerable.Empty<IGrouping<string, SearchParameter>>();

        var filtered = StateService.CachedSearchParameters.AsEnumerable();

        // Apply className filter
        if (!string.IsNullOrWhiteSpace(filterClassName))
        {
            filtered = filtered.Where(p => p.ClassName.Equals(filterClassName, StringComparison.OrdinalIgnoreCase));
        }

        // Apply text filter
        if (!string.IsNullOrWhiteSpace(filterText))
        {
            filtered = filtered.Where(p =>
                p.ClassName.Contains(filterText, StringComparison.OrdinalIgnoreCase) ||
                p.SearcherUserId.ToString().Contains(filterText, StringComparison.OrdinalIgnoreCase) ||
                p.SiteCode.ToString().Contains(filterText, StringComparison.OrdinalIgnoreCase) ||
                (p.Description ?? "").Contains(filterText, StringComparison.OrdinalIgnoreCase));
        }

        return filtered.GroupBy(p => p.ClassName).OrderBy(g => g.Key);
    }

    public void Dispose()
    {
        StateService.StateChanged -= OnStateChanged;
    }
}
